# 批量并发发布使用指南

## 功能说明

`batch_publish.py` 是一个批量并发发布脚本，可以将 `posts` 目录下的所有 Markdown 文件自动发布到多个平台。

### 核心特性

1. **循环发布**：遍历所有文章，每篇文章依次处理
2. **并发发布**：每篇文章同时发布到多个平台（使用线程池）
3. **智能管理**：自动过滤非文章文件（如 README.md）
4. **详细统计**：实时显示发布进度和结果统计

## 使用方法

### 1. 基本使用

```bash
python batch_publish.py
```

默认配置：
- 并发数：3（同时向3个平台发布）
- 目标平台：csdn、juejin、cto51、zhihu、alicloud、toutiao

### 2. 自定义并发数

```bash
# 使用2个并发（更保守，更稳定）
python batch_publish.py --workers 2

# 使用6个并发（更激进，更快速）
python batch_publish.py --workers 6
```

### 3. 演练模式（推荐首次使用）

```bash
# 查看发布计划，但不实际发布
python batch_publish.py --dry-run
```

## 前置准备

### 1. 启动 Chrome 调试模式

```bash
bash scripts/start_chrome.sh
```

或手动启动：

```bash
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir="/tmp/chrome_dev" \
  about:blank
```

### 2. 配置平台启用状态

编辑 `config/common.yaml`：

```yaml
enable:
  csdn: True      # 启用 CSDN
  juejin: True    # 启用掘金
  cto51: True     # 启用 51CTO
  zhihu: True     # 启用知乎
  alicloud: True  # 启用阿里云
  toutiao: True   # 启用今日头条
  wechat: False   # 微信公众号（暂不支持并发）
```

### 3. 准备文章

将要发布的 Markdown 文章放在 `posts` 目录：

```
posts/
  ├── 文章1.md
  ├── 文章2.md
  └── 文章3.md
```

## 工作流程

假设 `posts` 目录有 10 篇文章，启用了 6 个平台：

```
第1轮：文章1.md
  ├── [并发] → CSDN
  ├── [并发] → 掘金
  ├── [并发] → 51CTO
  ├── [并发] → 知乎
  ├── [并发] → 阿里云
  └── [并发] → 今日头条
  
第2轮：文章2.md
  ├── [并发] → CSDN
  ├── [并发] → 掘金
  ... (同上)

... 依此类推，共10轮
```

**总任务数**：10 篇文章 × 6 个平台 = 60 个发布任务

## 技术说明

### 并发机制

- **实现方式**：使用 Python `concurrent.futures.ThreadPoolExecutor`
- **共享资源**：所有平台共享同一个 Chrome 浏览器实例
- **线程安全**：每个线程在不同标签页操作，通过 Selenium 自动切换

### 为什么不是真正的"并发"？

由于所有平台共享一个 Chrome 浏览器实例（调试模式限制），实际上是：
- **快速切换**：线程池轮流操作浏览器的不同标签页
- **并发效果**：比顺序发布快 2-3 倍
- **资源限制**：不建议 workers 超过 6

### 浏览器调试模式限制

当前使用 `--remote-debugging-port=9222` 只能启动**单个** Chrome 实例：

```
✅ 支持：共享浏览器，快速切换标签页
❌ 不支持：真正的多进程并发（需要多个调试端口）
```

## 完全并发方案（高级）

如果需要真正的并发（每个平台独立浏览器），需要：

### 1. 启动多个 Chrome 实例

```bash
# Chrome 实例 1 - CSDN
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir="/tmp/chrome_csdn" &

# Chrome 实例 2 - 掘金
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9223 \
  --user-data-dir="/tmp/chrome_juejin" &

# ... 每个平台一个实例
```

### 2. 修改配置

为每个平台配置独立的调试端口：

```yaml
# config/csdn.yaml
debugger_address: 127.0.0.1:9222

# config/juejin.yaml
debugger_address: 127.0.0.1:9223

# ... 依此类推
```

### 3. 使用多进程

修改 `batch_publish.py` 使用 `multiprocessing.Pool` 替代 `ThreadPoolExecutor`。

**注意**：这种方案更复杂，资源消耗更大，一般不需要。

## 常见问题

### Q1: 并发数应该设置多少？

**推荐**：
- 2-3：更稳定，适合网络不好或平台限制严格的情况
- 4-6：更快速，适合网络好且平台限制宽松的情况
- >6：不推荐，可能导致浏览器卡顿或平台限流

### Q2: 为什么有些平台发布失败？

可能原因：
1. **登录过期**：首次使用需要手动登录
2. **网络问题**：平台访问超时
3. **平台限制**：发布太快触发反爬虫
4. **元素变化**：平台页面改版，选择器失效

**解决**：
- 查看日志：`data/logs/` 目录
- 降低并发数：`--workers 2`
- 手动测试：`python publish.py` 单独测试失败的平台

### Q3: 如何处理登录问题？

**首次使用**：
1. 运行 `python publish.py` 手动登录各平台
2. 登录状态会自动保存到 `data/cookies/`
3. 再运行 `python batch_publish.py` 批量发布

**登录过期**：
- 删除对应平台的 cookie：`rm data/cookies/<platform>_cookies.pkl`
- 重新手动登录

### Q4: 可以中断后继续吗？

目前不支持断点续传，中断后需要重新运行。

**建议**：
- 先用 `--dry-run` 查看计划
- 分批处理：将文章分成多个目录
- 降低并发数避免失败

## 性能对比

以 10 篇文章 × 6 个平台 = 60 个任务为例：

| 方式 | 预计耗时 | 说明 |
|------|---------|------|
| 顺序发布 | 60-120分钟 | 每个任务 1-2 分钟 |
| 并发发布（workers=3） | 20-40分钟 | 节省 60-70% |
| 并发发布（workers=6） | 10-20分钟 | 节省 80-85% |

**注意**：实际耗时取决于网络速度、平台响应、文章长度等因素。

## 日志查看

发布过程中的详细日志保存在：

```
data/logs/batch_publish_YYYYMMDD.log
```

查看实时日志：

```bash
tail -f data/logs/batch_publish_*.log
```

## 示例输出

```
================================================================================
批量并发发布工具 v1.0
================================================================================
找到 10 篇文章待发布：
  1. AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
  2. RAG模型革命：大模型时代的问答系统最佳实践揭秘.md
  ... (省略)

启用的平台：CSDN, JUEJIN, CTO51, ZHIHU, ALICLOUD, TOUTIAO

================================================================================
📢 即将发布 10 篇文章到 6 个平台
   每篇文章将并发发布（并发数：3）
================================================================================
是否继续？(y/n): y

################################################################################
进度：[1/10] 正在处理文章：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
################################################################################

================================================================================
开始并发发布文章：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
目标平台：CSDN, JUEJIN, CTO51, ZHIHU, ALICLOUD, TOUTIAO
并发数：3
================================================================================

[CSDN] 开始发布：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
[JUEJIN] 开始发布：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
[CTO51] 开始发布：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
✓ [CSDN] 发布成功：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
[ZHIHU] 开始发布：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
✓ [JUEJIN] 发布成功：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
[ALICLOUD] 开始发布：AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
...

================================================================================
文章 [AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md] 发布完成
成功：6/6, 失败：0/6
详细结果：
  - CSDN: ✓ 成功
  - JUEJIN: ✓ 成功
  - CTO51: ✓ 成功
  - ZHIHU: ✓ 成功
  - ALICLOUD: ✓ 成功
  - TOUTIAO: ✓ 成功
================================================================================

... (继续处理其他文章)

================================================================================
🎉 批量发布完成！
================================================================================
总耗时：1256.78 秒（20.95 分钟）
总文章数：10
总任务数：60

详细结果：

  📄 AI大模型革命：揭秘哔站"血洗"背后的深度学习奥秘.md
      ✓ CSDN
      ✓ JUEJIN
      ✓ CTO51
      ✓ ZHIHU
      ✓ ALICLOUD
      ✓ TOUTIAO
  
  ... (其他文章)

================================================================================
总成功：58/60 (96.7%)
总失败：2/60 (3.3%)
================================================================================
```

## 安全建议

1. **首次运行演练**：使用 `--dry-run` 查看计划
2. **备份文章**：批量发布前备份 `posts` 目录
3. **小批量测试**：先用 2-3 篇文章测试
4. **监控日志**：注意查看失败原因
5. **遵守规则**：避免频繁发布触发平台限制

## 后续优化

可能的改进方向：

1. **断点续传**：记录已发布文章，支持中断后继续
2. **重试机制**：失败的任务自动重试
3. **智能调度**：根据平台响应速度动态调整并发数
4. **发布队列**：支持定时发布、延迟发布
5. **结果导出**：生成 CSV 或 Excel 格式的发布报告

---

**祝发布愉快！** 🚀
