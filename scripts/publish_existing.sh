#!/bin/bash

# æ‰¹é‡å‘å¸ƒç°æœ‰æ–‡ç« è„šæœ¬
# è¿™ä¸ªè„šæœ¬ä¼šå°† posts ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ç« å‘å¸ƒåˆ°æ‰€æœ‰å¯ç”¨çš„å¹³å°
# ä¸ä¼šç”Ÿæˆæ–°å†…å®¹ï¼Œåªæ˜¯å‘å¸ƒå·²æœ‰çš„æ–‡ç« 

set -e

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•çš„çˆ¶ç›®å½•ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

echo "========================================"
echo "ğŸ“¤ æ‰¹é‡å‘å¸ƒç°æœ‰æ–‡ç« "
echo "========================================"
echo ""

# æ£€æŸ¥ Chrome æ˜¯å¦åœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¿è¡Œ
echo "ğŸ” æ£€æŸ¥ Chrome è°ƒè¯•æ¨¡å¼..."
if ! lsof -i :9222 > /dev/null 2>&1; then
    echo "âš ï¸  Chrome è°ƒè¯•æ¨¡å¼æœªè¿è¡Œ"
    echo ""
    echo "æ­£åœ¨å¯åŠ¨ Chrome è°ƒè¯•æ¨¡å¼..."
    bash scripts/start_chrome.sh &
    
    # ç­‰å¾… Chrome å¯åŠ¨
    sleep 3
    
    if ! lsof -i :9222 > /dev/null 2>&1; then
        echo "âŒ Chrome å¯åŠ¨å¤±è´¥"
        exit 1
    fi
    
    echo "âœ… Chrome è°ƒè¯•æ¨¡å¼å·²å¯åŠ¨"
else
    echo "âœ… Chrome è°ƒè¯•æ¨¡å¼å·²è¿è¡Œ"
fi

echo ""
echo "========================================"
echo "ğŸ“ å¼€å§‹æ‰¹é‡å‘å¸ƒ..."
echo "========================================"
echo ""

# è¿è¡Œæµæ°´çº¿ï¼ˆè·³è¿‡å†…å®¹ç”Ÿæˆï¼‰
python3 auto_publish_pipeline.py \
    --skip-generation \
    --publish-delay 3.0

echo ""
echo "========================================"
echo "âœ… æ‰¹é‡å‘å¸ƒå®Œæˆ"
echo "========================================"
echo ""
